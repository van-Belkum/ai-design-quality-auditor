version: 1

nlp:
  fuzzy_threshold: 87
  case_insensitive: true

lookups:
  - name: mimo_matrix
    file: mimo_matrix.csv
  - name: supplier_aliases
    file: supplier_aliases.csv
  - name: doc_clauses
    file: doc_clauses.csv

tokens:
  rfts: ["right first time", "rft%", "rft percentage"]
  title_block: ["title", "title block", "drawing number", "revision"]

groups:

  - id: GLOBAL_BASICS
    name: Global Basics
    rules:
      - id: TITLE_BLOCK_PRESENT
        name: Title block must be present
        severity: major
        source: { document: "GEN-DWG-STD-001", clause: "3.1" }
        checks:
          - type: must_contain_any
            tokens: "@title_block"
            scope: page_any

      - id: SCALE_SHOWN
        name: Scale must be shown on first page
        severity: minor
        source: { document: "GEN-DWG-STD-001", clause: "3.4" }
        checks:
          - type: must_contain
            token: "SCALE"
            scope: first_page

      - id: ADDRESS_MATCHES_TITLE
        name: Site Address must match drawing title (ignore “, 0 ,”)
        severity: major
        source: { document: "GEN-DWG-STD-002", clause: "2.2" }
        conditions:
          all:
            - field: site_address
              not_in: ["", "0", "0, 0"]
        checks:
          - type: title_contains_site_address_normalized
            normalizers: ["strip_commas", "squash_spaces", "upper"]

  - id: CLIENT_SPECIFIC
    name: Client / Project specific
    rules:
      # Example placeholder: copy this structure for real rules
      - id: BTEE_PWRRES_NO_MIMO_REQUIRED
        name: MIMO config optional for Power Resilience
        severity: info
        source: { document: "BTEE-PR-POW-001", clause: "2.1" }
        conditions:
          all:
            - field: client
              eq: "BTEE"
            - field: project
              eq: "Power Resilience"
        checks:
          - type: suppress_field_required
            field: mimo_required

      - id: VODAFONE_GF_LABEL
        name: Vodafone Greenfield earthing label wording
        severity: major
        source: { document: "VF-ELEC-STD-004", clause: "5.2" }
        conditions:
          all:
            - field: client
              eq: "Vodafone"
            - field: site_type
              eq: "Greenfield"
        checks:
          - type: must_contain
            token: "EARTH BAR CONNECTION LABEL: DO NOT REMOVE"
            scope: page_any

  - id: MIMO_POLICY
    name: MIMO policy derived from lookups
    rules:
      - id: DEFAULT_MIMO_BY_VENDOR
        name: Default MIMO string must match vendor/sector policy
        severity: major
        source: { document: "RAN-MIMO-POL-001", clause: "Table 2" }
        conditions:
          all:
            - field: project
              in: ["RAN", "Beacon 4"]
            - field: sectors_qty
              in: [1, 2, 3, 4, 5, 6]
            - field: proposed_vendor
              in: ["Ericsson", "Nokia"]
        checks:
          - type: campo_equals_lookup
            compare:
              field: mimo_s1
              lookup: mimo_matrix
              where:
                vendor: "${proposed_vendor}"
                sectors_qty: "${sectors_qty}"
              equals_column: default_mimo
          - type: copy_if_same_all
            field_from: mimo_s1
            fields_to: ["mimo_s2","mimo_s3","mimo_s4","mimo_s5","mimo_s6"]
            enabled_if:
              field: mimo_same_all
              eq: true

  - id: TYPOS_AND_CODES
    name: Typos and code normalization
    rules:
      - id: DENY_AHEGC
        name: Forbid AHEGC (use AHEGG instead)
        severity: minor
        source: { document: "CTIL-CODELIST-2024", clause: "Annex A" }
        checks:
          - type: must_not_contain
            token: "AHEGC"
